<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProConnect - Messages</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0078D4',
                        primaryLight: '#50A0E4',
                        primaryDark: '#106EBE',
                        secondary: '#2BC48A',
                        accent: '#FFB900',
                        danger: '#E74C3C',
                        success: '#27AE60',
                        lightBg: '#FFFFFF',
                        lightSecondary: '#F8F9FA',
                        lightTertiary: '#E9ECEF',
                        textDark: '#212529',
                        textMedium: '#495057',
                        textLight: '#6C757D'
                    }
                }
            }
        }
    </script>
    <style>
        .chat-bubble-received {
            border-radius: 18px 18px 18px 4px;
        }
        .chat-bubble-sent {
            border-radius: 18px 18px 4px 18px;
        }
        
        /* User search panel animation */
        .slide-in {
            animation: slideIn 0.3s forwards;
        }
        
        .slide-out {
            animation: slideOut 0.3s forwards;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); }
            to { transform: translateX(100%); }
        }
        
        /* Empty state animations */
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }
    </style>
</head>
<body class="bg-lightBg text-textDark min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-md pb-20">
        <!-- App Header -->
        <header class="flex justify-between items-center mb-6">
            <a href="index.html" class="text-primary">
                <i class="fas fa-arrow-left text-xl"></i>
            </a>
            <h1 class="text-xl font-bold text-primary">Messages</h1>
            <button id="newMessageBtn" class="text-primary">
                <i class="fas fa-edit text-xl"></i>
            </button>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Tabs -->
            <div class="flex border-b mb-4">
                <button class="text-primary border-b-2 border-primary pb-2 px-4 font-medium">Conversations</button>
                <button class="text-textMedium pb-2 px-4 font-medium">Connections</button>
            </div>

            <!-- Search Box -->
            <div class="mb-4">
                <div class="relative">
                    <input type="text" id="conversationSearch" placeholder="Search conversations" class="w-full px-4 py-2 pl-10 rounded-lg border focus:outline-none focus:ring-2 focus:ring-primary">
                    <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-textLight">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
            </div>

            <!-- Authentication Check -->
            <div id="authCheck" class="hidden flex flex-col items-center justify-center py-8">
                <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mb-4">
                    <i class="fas fa-lock text-primary text-2xl"></i>
                </div>
                <h3 class="text-lg font-semibold mb-2">Sign in to view messages</h3>
                <p class="text-textMedium mb-4 text-center">Please sign in or create an account to access your messages</p>
                <div class="flex space-x-4">
                    <a href="index.html" class="bg-primary text-white px-6 py-2 rounded-lg">
                        Sign In
                    </a>
                    <a href="onboarding.html" class="bg-lightTertiary text-textDark px-6 py-2 rounded-lg">
                        Sign Up
                    </a>
                </div>
            </div>

            <!-- Empty State (When no messages) -->
            <div id="emptyState" class="flex flex-col items-center justify-center py-8 hidden">
                <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mb-4 pulse">
                    <i class="fas fa-comments text-primary text-2xl"></i>
                </div>
                <h3 class="text-lg font-semibold mb-2">No messages yet</h3>
                <p class="text-textMedium mb-4 text-center">Start a conversation with your connections</p>
                <button id="startConversationBtn" class="bg-primary text-white px-6 py-2 rounded-lg flex items-center">
                    <i class="fas fa-plus mr-2"></i> New Message
                </button>
            </div>

            <!-- Messages List (Shown only if authenticated and has messages) -->
            <div id="messagesList" class="space-y-2">
                <!-- Messages will be populated here -->
            </div>
        </main>

        <!-- Active Chat View (Hidden initially, shown when a chat is clicked) -->
        <div id="chatView" class="fixed inset-0 bg-lightBg z-50 hidden">
            <div class="h-full flex flex-col">
                <!-- Chat Header -->
                <div class="bg-white p-4 border-b flex items-center">
                    <button id="backToChats" class="text-primary mr-3">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </button>
                    <img id="chatUserImage" src="" class="w-10 h-10 rounded-full object-cover mr-3" alt="Profile photo">
                    <div>
                        <h3 id="chatUserName" class="font-medium"></h3>
                        <p id="chatUserStatus" class="text-xs text-textMedium"></p>
                    </div>
                    <div class="ml-auto flex space-x-4">
                        <button id="viewProfileBtn" class="text-primary">
                            <i class="fas fa-user"></i>
                        </button>
                        <button class="text-primary">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Chat Messages -->
                <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4">
                    <!-- Messages will be populated by JavaScript -->
                </div>
                
                <!-- Message Input -->
                <div class="bg-white p-3 border-t">
                    <div class="flex items-center">
                        <button class="text-primary p-2">
                            <i class="fas fa-plus"></i>
                        </button>
                        <input type="text" id="messageInput" placeholder="Type a message..." class="flex-1 px-4 py-2 rounded-full border focus:outline-none focus:ring-2 focus:ring-primary">
                        <button class="text-primary p-2">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button id="sendMessageBtn" class="bg-primary text-white p-2 rounded-full ml-2">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Message Panel (Hidden initially) -->
        <div id="newMessagePanel" class="fixed inset-0 bg-lightBg z-50 hidden">
            <div class="h-full flex flex-col">
                <!-- Panel Header -->
                <div class="bg-white p-4 border-b flex items-center">
                    <button id="closeNewMessageBtn" class="text-primary mr-3">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </button>
                    <h3 class="font-medium">New Message</h3>
                </div>
                
                <!-- Search Users -->
                <div class="p-4 border-b">
                    <div class="relative">
                        <input type="text" id="userSearchInput" placeholder="Search users..." class="w-full px-4 py-2 pl-10 rounded-lg border focus:outline-none focus:ring-2 focus:ring-primary">
                        <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-textLight">
                            <i class="fas fa-search"></i>
                        </div>
                    </div>
                </div>
                
                <!-- User Results -->
                <div id="userSearchResults" class="flex-1 overflow-y-auto p-4">
                    <!-- User search results will be populated here -->
                    <div class="text-center text-textMedium py-10">
                        Search for users to start a conversation
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t p-3 flex justify-around">
            <a href="index.html" class="text-textLight flex flex-col items-center">
                <i class="fas fa-home text-xl"></i>
                <span class="text-xs mt-1">Home</span>
            </a>
            <a href="chat.html" class="text-primary flex flex-col items-center">
                <i class="fas fa-comments text-xl"></i>
                <span class="text-xs mt-1">Chat</span>
            </a>
            <a href="search.html" class="text-textLight flex flex-col items-center">
                <i class="fas fa-search text-xl"></i>
                <span class="text-xs mt-1">Find</span>
            </a>
            <a href="profile.html" class="text-textLight flex flex-col items-center">
                <i class="fas fa-user text-xl"></i>
                <span class="text-xs mt-1">Profile</span>
            </a>
        </nav>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const authCheck = document.getElementById('authCheck');
            const messagesList = document.getElementById('messagesList');
            const emptyState = document.getElementById('emptyState');
            const chatView = document.getElementById('chatView');
            const newMessagePanel = document.getElementById('newMessagePanel');
            const newMessageBtn = document.getElementById('newMessageBtn');
            const startConversationBtn = document.getElementById('startConversationBtn');
            const closeNewMessageBtn = document.getElementById('closeNewMessageBtn');
            const backToChats = document.getElementById('backToChats');
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            const messageInput = document.getElementById('messageInput');
            const userSearchInput = document.getElementById('userSearchInput');
            const userSearchResults = document.getElementById('userSearchResults');
            const conversationSearch = document.getElementById('conversationSearch');
            const viewProfileBtn = document.getElementById('viewProfileBtn');
            
            // Current state
            let currentUser = JSON.parse(localStorage.getItem('currentUser'));
            let currentChatUserId = null;
            let registeredUsers = [];
            let conversations = [];
            
            // Check if user is logged in
            if (!currentUser) {
                // Show auth check message and hide messages list
                authCheck.classList.remove('hidden');
                messagesList.classList.add('hidden');
                emptyState.classList.add('hidden');
                return;
            } else {
                // Hide auth check message
                authCheck.classList.add('hidden');
                
                // Load conversations and registered users
                loadConversations();
                loadUsers();
                
                // Display conversations or empty state
                displayConversations();
            }
            
            // Function to load conversations
            function loadConversations() {
                // Get conversations from localStorage
                const storedConversations = JSON.parse(localStorage.getItem('userConversations_' + currentUser.id)) || [];
                conversations = storedConversations;
            }
            
            // Function to save conversations
            function saveConversations() {
                localStorage.setItem('userConversations_' + currentUser.id, JSON.stringify(conversations));
            }
            
            // Function to load registered users
            function loadUsers() {
                // Get all stored users from various sources
                
                // 1. Get from sampleUsers (if using the dummy data from search.html)
                const sampleUsers = JSON.parse(localStorage.getItem('sampleUsers')) || [];
                
                // 2. Try to get any registered users
                let registeredUsersList = [];
                
                // Scan localStorage for user data with a specific pattern
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    
                    // Check if this is a user object (not the current user or other data)
                    if (key === 'currentUser') {
                        continue; // Skip current user
                    }
                    
                    try {
                        const value = JSON.parse(localStorage.getItem(key));
                        // Check if this looks like a user object
                        if (value && value.fullName && value.id && value.id !== currentUser.id) {
                            registeredUsersList.push(value);
                        }
                    } catch (e) {
                        // Not a valid JSON, skip
                        continue;
                    }
                }
                
                // Combine users from different sources, avoiding duplicates
                const allUsers = [...sampleUsers, ...registeredUsersList];
                
                // Remove duplicates by ID
                const userMap = new Map();
                allUsers.forEach(user => {
                    if (!userMap.has(user.id)) {
                        userMap.set(user.id, user);
                    }
                });
                
                // Also ensure current user's connections are included
                if (currentUser.connections) {
                    currentUser.connections.forEach(conn => {
                        if (!userMap.has(conn.id)) {
                            // Create a minimal user object if not found elsewhere
                            userMap.set(conn.id, {
                                id: conn.id,
                                fullName: conn.name,
                                profileImage: conn.profileImage || "https://images.unsplash.com/photo-1494790108377-be9c29b29330?ixlib=rb-1.2.1&auto=format&fit=facearea&facepad=2&w=300&h=300&q=80"
                            });
                        }
                    });
                }
                
                // Convert map to array
                registeredUsers = Array.from(userMap.values());
            }
            
            // Function to display conversations
            function displayConversations() {
                // Filter conversations based on search term
                const searchTerm = conversationSearch.value.toLowerCase();
                
                let filteredConversations = conversations;
                
                if (searchTerm) {
                    filteredConversations = conversations.filter(convo => {
                        const user = findUserById(convo.userId);
                        return user && user.fullName.toLowerCase().includes(searchTerm);
                    });
                }
                
                // If no conversations, show empty state
                if (filteredConversations.length === 0) {
                    messagesList.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    return;
                }
                
                // Show messages list and hide empty state
                messagesList.classList.remove('hidden');
                emptyState.classList.add('hidden');
                
                // Sort conversations by latest message time
                filteredConversations.sort((a, b) => {
                    const aLatest = a.messages.length > 0 ? a.messages[a.messages.length - 1].timestamp : 0;
                    const bLatest = b.messages.length > 0 ? b.messages[b.messages.length - 1].timestamp : 0;
                    return bLatest - aLatest; // Newest first
                });
                
                // Clear messages list
                messagesList.innerHTML = '';
                
                // Add each conversation
                filteredConversations.forEach(conversation => {
                    const user = findUserById(conversation.userId);
                    if (!user) return; // Skip if user not found
                    
                    // Determine latest message info
                    let latestMessage = '';
                    let latestTime = '';
                    let unreadCount = 0;
                    
                    if (conversation.messages.length > 0) {
                        const lastMsg = conversation.messages[conversation.messages.length - 1];
                        latestMessage = lastMsg.content;
                        
                        // Format timestamp
                        const msgDate = new Date(lastMsg.timestamp);
                        const today = new Date();
                        const yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 1);
                        
                        if (msgDate.toDateString() === today.toDateString()) {
                            // Today - show time
                            latestTime = msgDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        } else if (msgDate.toDateString() === yesterday.toDateString()) {
                            // Yesterday
                            latestTime = 'Yesterday';
                        } else {
                            // Earlier - show date
                            latestTime = msgDate.toLocaleDateString([], { month: 'short', day: 'numeric' });
                        }
                        
                        // Count unread messages
                        unreadCount = conversation.messages.filter(msg => !msg.read && msg.sender !== currentUser.id).length;
                    }
                    
                    // Create conversation item
                    const item = document.createElement('div');
                    item.className = 'chat-item bg-lightSecondary p-3 rounded-lg cursor-pointer hover:bg-primary/5 transition';
                    item.dataset.userId = conversation.userId;
                    
                    // User online status - random for demo
                    const isOnline = Math.random() > 0.5;
                    
                    item.innerHTML = `
                        <div class="flex items-center">
                            <div class="relative mr-3">
                                <img src="${user.profileImage || 'https://via.placeholder.com/200'}" class="w-12 h-12 rounded-full object-cover" alt="Profile photo">
                                ${isOnline ? '<div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>' : ''}
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between">
                                    <h3 class="font-medium">${user.fullName}</h3>
                                    <span class="text-xs text-textLight">${latestTime}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <p class="text-sm text-textMedium truncate">${latestMessage || 'Start a conversation'}</p>
                                    ${unreadCount > 0 ? `<span class="bg-primary text-white text-xs rounded-full h-5 w-5 flex items-center justify-center ml-2">${unreadCount}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    messagesList.appendChild(item);
                    
                    // Add click handler
                    item.addEventListener('click', function() {
                        openChat(conversation.userId);
                    });
                });
            }
            
            // Function to find user by ID
            function findUserById(userId) {
                return registeredUsers.find(user => user.id == userId);
            }
            
            // Function to open chat with a specific user
            function openChat(userId) {
                // Find user
                const user = findUserById(userId);
                if (!user) return;
                
                // Find or create conversation
                let conversation = conversations.find(convo => convo.userId == userId);
                
                if (!conversation) {
                    // Create new conversation
                    conversation = {
                        userId: userId,
                        messages: []
                    };
                    conversations.push(conversation);
                    saveConversations();
                }
                
                // Set current chat user
                currentChatUserId = userId;
                
                // Update chat header
                document.getElementById('chatUserName').textContent = user.fullName;
                document.getElementById('chatUserStatus').textContent = Math.random() > 0.5 ? 'Online' : 'Last seen recently';
                document.getElementById('chatUserImage').src = user.profileImage || 'https://via.placeholder.com/200';
                
                // Mark all messages as read
                conversation.messages.forEach(msg => {
                    if (msg.sender !== currentUser.id) {
                        msg.read = true;
                    }
                });
                saveConversations();
                
                // Display messages
                displayChatMessages(conversation);
                
                // Show chat view
                chatView.classList.remove('hidden');
            }
            
            // Function to display chat messages
            function displayChatMessages(conversation) {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = '';
                
                // If no messages, show welcome message
                if (conversation.messages.length === 0) {
                    const welcomeDiv = document.createElement('div');
                    welcomeDiv.className = 'flex justify-center';
                    welcomeDiv.innerHTML = `
                        <div class="bg-primary/5 px-4 py-2 rounded-lg text-center">
                            <p class="text-sm text-textMedium">
                                This is the beginning of your conversation.<br>
                                Say hello!
                            </p>
                        </div>
                    `;
                    messagesContainer.appendChild(welcomeDiv);
                    return;
                }
                
                // Group messages by date
                let currentDate = null;
                
                conversation.messages.forEach(message => {
                    const msgDate = new Date(message.timestamp);
                    const msgDateStr = msgDate.toDateString();
                    
                    // Add date separator if needed
                    if (msgDateStr !== currentDate) {
                        currentDate = msgDateStr;
                        
                        const today = new Date();
                        const yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 1);
                        
                        let dateLabel;
                        
                        if (msgDateStr === today.toDateString()) {
                            dateLabel = 'Today';
                        } else if (msgDateStr === yesterday.toDateString()) {
                            dateLabel = 'Yesterday';
                        } else {
                            dateLabel = msgDate.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' });
                        }
                        
                        const dateSeparator = document.createElement('div');
                        dateSeparator.className = 'flex justify-center my-4';
                        dateSeparator.innerHTML = `
                            <span class="text-xs text-textLight bg-lightBg px-3 py-1 rounded-full">${dateLabel}</span>
                        `;
                        messagesContainer.appendChild(dateSeparator);
                    }
                    
                    // Add message
                    const messageElement = document.createElement('div');
                    
                    if (message.sender === currentUser.id) {
                        // Sent message
                        messageElement.className = 'flex justify-end';
                        messageElement.innerHTML = `
                            <div class="max-w-[80%]">
                                <div class="bg-primary text-white p-3 chat-bubble-sent">
                                    <p class="text-sm">${message.content}</p>
                                </div>
                                <div class="flex justify-end items-center mt-1">
                                    <span class="text-xs text-textLight mr-1">${formatMessageTime(message.timestamp)}</span>
                                    <i class="fas fa-check text-xs ${message.read ? 'text-success' : 'text-textLight'}"></i>
                                </div>
                            </div>
                        `;
                    } else {
                        // Received message
                        const user = findUserById(message.sender);
                        messageElement.className = 'flex items-end';
                        messageElement.innerHTML = `
                            <img src="${user?.profileImage || 'https://via.placeholder.com/200'}" class="w-8 h-8 rounded-full object-cover mr-2" alt="Profile photo">
                            <div class="max-w-[80%]">
                                <div class="bg-lightSecondary p-3 chat-bubble-received">
                                    <p class="text-sm">${message.content}</p>
                                </div>
                                <span class="text-xs text-textLight ml-2">${formatMessageTime(message.timestamp)}</span>
                            </div>
                        `;
                    }
                    
                    messagesContainer.appendChild(messageElement);
                });
                
                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            // Function to format message time
            function formatMessageTime(timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            
            // Function to send a message
            function sendMessage() {
                const messageText = messageInput.value.trim();
                
                if (!messageText || !currentChatUserId) return;
                
                // Find conversation
                const conversation = conversations.find(convo => convo.userId == currentChatUserId);
                if (!conversation) return;
                
                // Create message object
                const newMessage = {
                    sender: currentUser.id,
                    content: messageText,
                    timestamp: Date.now(),
                    read: false
                };
                
                // Add message to conversation
                conversation.messages.push(newMessage);
                
                // Save conversations
                saveConversations();
                
                // Clear input
                messageInput.value = '';
                
                // Update display
                displayChatMessages(conversation);
                
                // Simulate received message after a delay (for demo purposes)
                setTimeout(() => {
                    simulateResponse(conversation);
                }, 1000 + Math.random() * 3000);
            }
            
            // Function to simulate response (for demo purposes)
            function simulateResponse(conversation) {
                // Set typing indicator
                const messagesContainer = document.getElementById('chatMessages');
                const typingElement = document.createElement('div');
                typingElement.className = 'flex items-end typing-indicator';
                typingElement.id = 'typingIndicator';
                
                const user = findUserById(conversation.userId);
                
                typingElement.innerHTML = `
                    <img src="${user?.profileImage || 'https://via.placeholder.com/200'}" class="w-8 h-8 rounded-full object-cover mr-2" alt="Profile photo">
                    <div class="max-w-[80%]">
                        <div class="bg-lightSecondary p-3 chat-bubble-received flex space-x-1">
                            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></span>
                            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
                        </div>
                    </div>
                `;
                
                messagesContainer.appendChild(typingElement);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Generate a response after a delay
                setTimeout(() => {
                    // Remove typing indicator
                    document.getElementById('typingIndicator')?.remove();
                    
                    // Sample responses
                    const responses = [
                        "That's interesting, tell me more!",
                        "I agree with your perspective.",
                        "Thanks for sharing that information!",
                        "Good point, I hadn't thought of it that way.",
                        "I'd love to discuss this further sometime.",
                        "That aligns with my experience as well.",
                        "What made you interested in this topic?",
                        "I appreciate your insights!",
                        "Let's schedule a call to discuss further.",
                        "Do you have any resources on this subject you could share?"
                    ];
                    
                    // Select random response
                    const responseText = responses[Math.floor(Math.random() * responses.length)];
                    
                    // Create message object
                    const responseMessage = {
                        sender: conversation.userId,
                        content: responseText,
                        timestamp: Date.now(),
                        read: true // Mark as read since we're already in the chat
                    };
                    
                    // Add message to conversation
                    conversation.messages.push(responseMessage);
                    
                    // Save conversations
                    saveConversations();
                    
                    // Update display
                    displayChatMessages(conversation);
                }, 1500);
            }
            
            // Function to search for users
            function searchUsers() {
                const searchTerm = userSearchInput.value.toLowerCase();
                
                // Clear previous results
                userSearchResults.innerHTML = '';
                
                if (!searchTerm) {
                    userSearchResults.innerHTML = `
                        <div class="text-center text-textMedium py-10">
                            Search for users to start a conversation
                        </div>
                    `;
                    return;
                }
                
                // Filter users based on search term
                const filteredUsers = registeredUsers.filter(user => 
                    user.fullName.toLowerCase().includes(searchTerm) ||
                    (user.currentRole && user.currentRole.toLowerCase().includes(searchTerm)) ||
                    (user.company && user.company.toLowerCase().includes(searchTerm))
                );
                
                if (filteredUsers.length === 0) {
                    userSearchResults.innerHTML = `
                        <div class="text-center text-textMedium py-10">
                            No users found matching "${searchTerm}"
                        </div>
                    `;
                    return;
                }
                
                // Create results
                filteredUsers.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.className = 'flex items-center p-3 rounded-lg cursor-pointer hover:bg-primary/5 transition';
                    
                    userItem.innerHTML = `
                        <img src="${user.profileImage || 'https://via.placeholder.com/200'}" class="w-12 h-12 rounded-full object-cover mr-3" alt="Profile photo">
                        <div>
                            <h3 class="font-medium">${user.fullName}</h3>
                            <p class="text-sm text-textMedium">${user.currentRole || ''} ${user.company ? 'at ' + user.company : ''}</p>
                        </div>
                    `;
                    
                    userSearchResults.appendChild(userItem);
                    
                    // Add click handler
                    userItem.addEventListener('click', function() {
                        startNewConversation(user.id);
                    });
                });
            }
            
            // Function to start a new conversation
            function startNewConversation(userId) {
                // Close new message panel
                newMessagePanel.classList.add('slide-out');
                
                setTimeout(() => {
                    newMessagePanel.classList.remove('slide-out');
                    newMessagePanel.classList.add('hidden');
                    
                    // Open chat with the selected user
                    openChat(userId);
                }, 300);
            }
            
            // Event Listeners
            
            // New message button
            newMessageBtn.addEventListener('click', function() {
                newMessagePanel.classList.remove('hidden');
                newMessagePanel.classList.add('slide-in');
                userSearchInput.value = '';
                searchUsers();
                userSearchInput.focus();
            });
            
            // Start conversation button (from empty state)
            startConversationBtn.addEventListener('click', function() {
                newMessageBtn.click();
            });
            
            // Close new message panel
            closeNewMessageBtn.addEventListener('click', function() {
                newMessagePanel.classList.add('slide-out');
                
                setTimeout(() => {
                    newMessagePanel.classList.remove('slide-out');
                    newMessagePanel.classList.add('hidden');
                }, 300);
            });
            
            // Back to chats button
            backToChats.addEventListener('click', function() {
                chatView.classList.add('hidden');
                currentChatUserId = null;
                
                // Refresh conversations list
                displayConversations();
            });
            
            // Send message button
            sendMessageBtn.addEventListener('click', function() {
                sendMessage();
            });
            
            // Send message on Enter key
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // User search input
            userSearchInput.addEventListener('input', function() {
                searchUsers();
            });
            
            // Conversation search input
            conversationSearch.addEventListener('input', function() {
                displayConversations();
            });
            
            // View profile button
            viewProfileBtn.addEventListener('click', function() {
                if (currentChatUserId) {
                    // Redirect to user profile page
                    window.location.href = `user-profile.html?id=${currentChatUserId}`;
                }
            });
        });
    </script>
</body>
</html>
