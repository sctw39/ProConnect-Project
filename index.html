<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProConnect - Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0078D4',
                        primaryLight: '#50A0E4',
                        primaryDark: '#106EBE',
                        secondary: '#2BC48A',
                        accent: '#FFB900',
                        danger: '#E74C3C',
                        success: '#27AE60',
                        lightBg: '#FFFFFF',
                        lightSecondary: '#F8F9FA',
                        lightTertiary: '#E9ECEF',
                        textDark: '#212529',
                        textMedium: '#495057',
                        textLight: '#6C757D'
                    }
                }
            }
        }
        
        // Check for dark mode
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
    <style>
        /* Animated progress bars */
        @keyframes growBar {
            from { width: 0%; }
            to { width: var(--target-width); }
        }
        
        .animate-grow {
            animation: growBar 1.2s ease-out forwards;
        }
        
        /* Card hover effect */
        .stat-card {
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Date selector styling */
        .date-selector button {
            transition: all 0.2s ease;
        }
        
        .date-selector button.active {
            background-color: rgba(0, 120, 212, 0.1);
            color: #0078D4;
            font-weight: 500;
        }
        
        /* Pulse animation */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        /* Loading animation */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        .loading-shimmer {
            background: linear-gradient(to right, #f6f7f8 8%, #edeef1 18%, #f6f7f8 33%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite linear;
        }
        
        /* Login prompt animation */
        @keyframes slideInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .slide-in-up {
            animation: slideInUp 0.5s forwards;
        }
        
        /* Dark mode styles */
        .dark .bg-white {
            background-color: #1E1E1E;
        }
        
        .dark .bg-lightBg {
            background-color: #121212;
        }
        
        .dark .bg-lightSecondary {
            background-color: #2A2A2A;
        }
        
        .dark .text-textDark {
            color: #E9ECEF;
        }
        
        .dark .text-textMedium {
            color: #ADB5BD;
        }
        
        .dark .text-textLight {
            color: #6C757D;
        }
        
        .dark .border-gray-200 {
            border-color: #2A2A2A;
        }
        
        .dark .loading-shimmer {
            background: linear-gradient(to right, #2A2A2A 8%, #3A3A3A 18%, #2A2A2A 33%);
        }
    </style>
</head>
<body class="bg-lightBg text-textDark min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-md pb-20">
        <!-- App Header -->
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center">
                <div class="bg-primary rounded-lg w-10 h-10 flex items-center justify-center text-white font-bold mr-2">PC</div>
                <h1 class="text-xl font-bold text-primary">Analytics</h1>
            </div>
            <div>
                <button id="refreshBtn" class="text-primary p-2">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </header>

        <!-- Not Logged In State -->
        <div id="notLoggedInState" class="hidden flex flex-col items-center justify-center py-8 slide-in-up">
            <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mb-4">
                <i class="fas fa-chart-line text-primary text-2xl"></i>
            </div>
            <h3 class="text-lg font-semibold mb-2">Sign in to view analytics</h3>
            <p class="text-textMedium mb-4 text-center">Track your professional growth and networking success</p>
            <div class="flex space-x-4">
                <a href="login.html" class="bg-primary text-white px-6 py-2 rounded-lg">
                    Sign In
                </a>
                <a href="register.html" class="bg-lightTertiary text-textDark px-6 py-2 rounded-lg">
                    Sign Up
                </a>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden">
            <!-- Date Range Selector (Loading) -->
            <div class="flex justify-between p-2 mb-6 overflow-x-auto">
                <div class="w-16 h-8 loading-shimmer rounded-full"></div>
                <div class="w-16 h-8 loading-shimmer rounded-full"></div>
                <div class="w-16 h-8 loading-shimmer rounded-full"></div>
                <div class="w-16 h-8 loading-shimmer rounded-full"></div>
            </div>

            <!-- Professional Score (Loading) -->
            <div class="bg-lightSecondary rounded-lg p-4 mb-4">
                <div class="flex justify-between items-center mb-2">
                    <div class="w-40 h-6 loading-shimmer rounded-md"></div>
                    <div class="w-12 h-6 loading-shimmer rounded-full"></div>
                </div>
                <div class="flex items-center">
                    <div class="w-16 h-12 loading-shimmer rounded-md mr-3"></div>
                    <div class="flex-1">
                        <div class="w-full h-3 loading-shimmer rounded-full"></div>
                        <div class="w-3/4 h-4 loading-shimmer rounded-md mt-2"></div>
                    </div>
                </div>
            </div>

            <!-- Key Analytics Metrics (Loading) -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-lightSecondary p-4 rounded-lg">
                    <div class="w-24 h-5 loading-shimmer rounded-md mb-2"></div>
                    <div class="w-16 h-8 loading-shimmer rounded-md"></div>
                    <div class="w-20 h-4 loading-shimmer rounded-md mt-2"></div>
                </div>
                <div class="bg-lightSecondary p-4 rounded-lg">
                    <div class="w-24 h-5 loading-shimmer rounded-md mb-2"></div>
                    <div class="w-16 h-8 loading-shimmer rounded-md"></div>
                    <div class="w-20 h-4 loading-shimmer rounded-md mt-2"></div>
                </div>
                <div class="bg-lightSecondary p-4 rounded-lg">
                    <div class="w-24 h-5 loading-shimmer rounded-md mb-2"></div>
                    <div class="w-16 h-8 loading-shimmer rounded-md"></div>
                    <div class="w-20 h-4 loading-shimmer rounded-md mt-2"></div>
                </div>
                <div class="bg-lightSecondary p-4 rounded-lg">
                    <div class="w-24 h-5 loading-shimmer rounded-md mb-2"></div>
                    <div class="w-16 h-8 loading-shimmer rounded-md"></div>
                    <div class="w-20 h-4 loading-shimmer rounded-md mt-2"></div>
                </div>
            </div>

            <!-- Network Distribution (Loading) -->
            <div class="bg-lightSecondary rounded-lg p-4 mb-4">
                <div class="w-40 h-6 loading-shimmer rounded-md mb-4"></div>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between mb-1">
                            <div class="w-20 h-4 loading-shimmer rounded-md"></div>
                            <div class="w-10 h-4 loading-shimmer rounded-md"></div>
                        </div>
                        <div class="w-full h-2 loading-shimmer rounded-full"></div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <div class="w-20 h-4 loading-shimmer rounded-md"></div>
                            <div class="w-10 h-4 loading-shimmer rounded-md"></div>
                        </div>
                        <div class="w-full h-2 loading-shimmer rounded-full"></div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <div class="w-20 h-4 loading-shimmer rounded-md"></div>
                            <div class="w-10 h-4 loading-shimmer rounded-md"></div>
                        </div>
                        <div class="w-full h-2 loading-shimmer rounded-full"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Analytics Content -->
        <div id="analyticsContent" class="hidden">
            <!-- Date Range Selector -->
            <div class="date-selector bg-lightSecondary rounded-lg flex justify-between p-2 mb-6 overflow-x-auto">
                <button class="px-3 py-1 rounded-full text-sm whitespace-nowrap active" data-range="30">30 Days</button>
                <button class="px-3 py-1 rounded-full text-sm whitespace-nowrap text-textMedium" data-range="90">3 Months</button>
                <button class="px-3 py-1 rounded-full text-sm whitespace-nowrap text-textMedium" data-range="180">6 Months</button>
                <button class="px-3 py-1 rounded-full text-sm whitespace-nowrap text-textMedium" data-range="365">1 Year</button>
            </div>

            <!-- Professional Score -->
            <div class="bg-primary/10 rounded-lg p-4 mb-6">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-primary font-semibold text-lg">Professional Score</h2>
                    <span id="scoreChange" class="bg-success/20 text-success text-xs px-2 py-1 rounded-full font-medium">+5%</span>
                </div>
                <div class="flex items-center">
                    <div id="professionalScore" class="text-4xl font-bold text-primary mr-3">84</div>
                    <div class="flex-1">
                        <div class="w-full bg-white/50 rounded-full h-3">
                            <div id="professionalScoreBar" class="bg-primary h-3 rounded-full animate-grow" style="--target-width: 84%"></div>
                        </div>
                        <p class="text-xs mt-1 text-textMedium">Based on profile completeness, engagement, and connections</p>
                    </div>
                </div>
            </div>

            <!-- Key Analytics Metrics -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <!-- Network Growth -->
                <div class="stat-card bg-white shadow-sm rounded-lg p-4">
                    <div class="flex items-start justify-between">
                        <div>
                            <h3 class="text-sm font-medium text-textMedium mb-1">Network Growth</h3>
                            <div class="flex items-baseline">
                                <span id="networkGrowth" class="text-2xl font-bold mr-1">12%</span>
                                <span id="networkGrowthChange" class="text-xs text-success"><i class="fas fa-arrow-up"></i></span>
                            </div>
                        </div>
                        <div class="bg-primary/10 p-2 rounded-lg">
                            <i class="fas fa-user-plus text-primary"></i>
                        </div>
                    </div>
                    <p id="networkGrowthDesc" class="text-xs text-textLight mt-2">16 new connections</p>
                </div>

                <!-- Profile Views -->
                <div class="stat-card bg-white shadow-sm rounded-lg p-4">
                    <div class="flex items-start justify-between">
                        <div>
                            <h3 class="text-sm font-medium text-textMedium mb-1">Profile Views</h3>
                            <div class="flex items-baseline">
                                <span id="profileViews" class="text-2xl font-bold mr-1">38</span>
                                <span id="profileViewsChange" class="text-xs text-success"><i class="fas fa-arrow-up"></i></span>
                            </div>
                        </div>
                        <div class="bg-primary/10 p-2 rounded-lg">
                            <i class="fas fa-eye text-primary"></i>
                        </div>
                    </div>
                    <p id="profileViewsDesc" class="text-xs text-textLight mt-2">+8% from last month</p>
                </div>

                <!-- Response Rate -->
                <div class="stat-card bg-white shadow-sm rounded-lg p-4">
                    <div class="flex items-start justify-between">
                        <div>
                            <h3 class="text-sm font-medium text-textMedium mb-1">Response Rate</h3>
                            <div class="flex items-baseline">
                                <span id="responseRate" class="text-2xl font-bold mr-1">82%</span>
                                <span id="responseRateChange" class="text-xs text-success"><i class="fas fa-arrow-up"></i></span>
                            </div>
                        </div>
                        <div class="bg-primary/10 p-2 rounded-lg">
                            <i class="fas fa-reply text-primary"></i>
                        </div>
                    </div>
                    <p id="responseRateDesc" class="text-xs text-textLight mt-2">Avg. response time: 4h</p>
                </div>

                <!-- Engagement -->
                <div class="stat-card bg-white shadow-sm rounded-lg p-4">
                    <div class="flex items-start justify-between">
                        <div>
                            <h3 class="text-sm font-medium text-textMedium mb-1">Engagement</h3>
                            <div class="flex items-baseline">
                                <span id="engagement" class="text-2xl font-bold mr-1">28</span>
                                <span id="engagementChange" class="text-xs text-danger"><i class="fas fa-arrow-down"></i></span>
                            </div>
                        </div>
                        <div class="bg-primary/10 p-2 rounded-lg">
                            <i class="fas fa-chart-line text-primary"></i>
                        </div>
                    </div>
                    <p id="engagementDesc" class="text-xs text-textLight mt-2">Interactions/week</p>
                </div>

                <!-- Match Success -->
                <div class="stat-card bg-white shadow-sm rounded-lg p-4 col-span-2">
                    <div class="flex items-start justify-between">
                        <div>
                            <h3 class="text-sm font-medium text-textMedium mb-1">Match Success</h3>
                            <div class="flex items-baseline">
                                <span id="matchSuccess" class="text-2xl font-bold mr-1">65%</span>
                                <span id="matchSuccessChange" class="text-xs text-success"><i class="fas fa-arrow-up"></i></span>
                            </div>
                        </div>
                        <div class="bg-primary/10 p-2 rounded-lg">
                            <i class="fas fa-handshake text-primary"></i>
                        </div>
                    </div>
                    <div class="mt-2">
                        <div class="w-full bg-lightTertiary rounded-full h-1.5">
                            <div id="matchSuccessBar" class="bg-primary h-1.5 rounded-full animate-grow" style="--target-width: 65%"></div>
                        </div>
                    </div>
                    <p id="matchSuccessDesc" class="text-xs text-textLight mt-1">Success rate of connection requests</p>
                </div>
            </div>

            <!-- Network Distribution -->
            <div class="bg-white shadow-sm rounded-lg p-4 mb-6">
                <h2 class="text-lg font-semibold mb-3">Network Distribution</h2>
                
                <div id="networkDistribution">
                    <!-- Industry distribution will be populated here -->
                </div>
            </div>

            <!-- Engagement Insights -->
            <div class="bg-white shadow-sm rounded-lg p-4 mb-6">
                <h2 class="text-lg font-semibold mb-3">Engagement Insights</h2>
                
                <div id="engagementInsights" class="space-y-3">
                    <!-- Insights will be populated here -->
                </div>
            </div>

            <!-- Growth Opportunities -->
            <div class="bg-white shadow-sm rounded-lg p-4 mb-6">
                <h2 class="text-lg font-semibold mb-3">Growth Opportunities</h2>
                
                <div id="growthOpportunities" class="space-y-4">
                    <!-- Growth tips will be populated here -->
                </div>
            </div>
        </div>

        <!-- No Profile Data State -->
        <div id="noDataState" class="hidden flex flex-col items-center justify-center py-8">
            <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mb-4 pulse-animation">
                <i class="fas fa-chart-bar text-primary text-2xl"></i>
            </div>
            <h3 class="text-lg font-semibold mb-2">No data to analyze yet</h3>
            <p class="text-textMedium mb-4 text-center">Complete your profile and start connecting with professionals to see your analytics</p>
            <div class="flex space-x-4">
                <a href="profile.html" class="bg-primary text-white px-6 py-2 rounded-lg">
                    Complete Profile
                </a>
                <a href="search.html" class="bg-lightTertiary text-textDark px-6 py-2 rounded-lg">
                    Find Connections
                </a>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t p-3 flex justify-around">
            <a href="index.html" class="text-primary flex flex-col items-center">
                <i class="fas fa-chart-line text-xl"></i>
                <span class="text-xs mt-1">Analytics</span>
            </a>
            <a href="chat.html" class="text-textLight flex flex-col items-center">
                <i class="fas fa-comments text-xl"></i>
                <span class="text-xs mt-1">Chat</span>
            </a>
            <a href="search.html" class="text-textLight flex flex-col items-center">
                <i class="fas fa-search text-xl"></i>
                <span class="text-xs mt-1">Find</span>
            </a>
            <a href="profile.html" class="text-textLight flex flex-col items-center">
                <i class="fas fa-user text-xl"></i>
                <span class="text-xs mt-1">Profile</span>
            </a>
        </nav>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM elements
            const notLoggedInState = document.getElementById('notLoggedInState');
            const loadingState = document.getElementById('loadingState');
            const analyticsContent = document.getElementById('analyticsContent');
            const noDataState = document.getElementById('noDataState');
            const refreshBtn = document.getElementById('refreshBtn');
            const networkDistribution = document.getElementById('networkDistribution');
            const engagementInsights = document.getElementById('engagementInsights');
            const growthOpportunities = document.getElementById('growthOpportunities');
            
            // Check if user is logged in
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!currentUser) {
                // Show not logged in state
                notLoggedInState.classList.remove('hidden');
                loadingState.classList.add('hidden');
                analyticsContent.classList.add('hidden');
                noDataState.classList.add('hidden');
                return;
            }
            
            // Show loading state initially
            notLoggedInState.classList.add('hidden');
            loadingState.classList.remove('hidden');
            analyticsContent.classList.add('hidden');
            noDataState.classList.add('hidden');
            
            // Load analytics data with a slight delay to show loading effect
            setTimeout(() => {
                // Hide loading state
                loadingState.classList.add('hidden');
                
                // Check if user has enough data for analytics
                if (hasEnoughData(currentUser)) {
                    // Show analytics content
                    analyticsContent.classList.remove('hidden');
                    noDataState.classList.add('hidden');
                    
                    // Initialize analytics with user data
                    initializeAnalytics(currentUser);
                } else {
                    // Show no data state
                    analyticsContent.classList.add('hidden');
                    noDataState.classList.remove('hidden');
                }
            }, 1500);
            
            // Refresh button click handler
            refreshBtn.addEventListener('click', function() {
                // Show loading state
                analyticsContent.classList.add('hidden');
                noDataState.classList.add('hidden');
                loadingState.classList.remove('hidden');
                
                // Simulate refresh with a delay
                setTimeout(() => {
                    // Hide loading state
                    loadingState.classList.add('hidden');
                    
                    // Reload current user data (might have changed)
                    const refreshedUser = JSON.parse(localStorage.getItem('currentUser'));
                    
                    if (hasEnoughData(refreshedUser)) {
                        // Show analytics content
                        analyticsContent.classList.remove('hidden');
                        
                        // Reinitialize analytics
                        initializeAnalytics(refreshedUser);
                    } else {
                        // Show no data state
                        noDataState.classList.remove('hidden');
                    }
                }, 1000);
            });
            
            // Date selector buttons
            const dateButtons = document.querySelectorAll('.date-selector button');
            dateButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons
                    dateButtons.forEach(btn => {
                        btn.classList.remove('active');
                        btn.classList.add('text-textMedium');
                    });
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    this.classList.remove('text-textMedium');
                    
                    // Get date range
                    const range = parseInt(this.getAttribute('data-range'));
                    
                    // Update analytics for selected time period
                    updateAnalyticsForRange(range);
                });
            });
            
            // Function to check if user has enough data for analytics
            function hasEnoughData(user) {
                // Check for minimum profile completion
                if (!user) return false;
                
                // Calculate profile completion percentage
                let completionPoints = 0;
                if (user.fullName) completionPoints += 15;
                if (user.currentRole) completionPoints += 10;
                if (user.company) completionPoints += 10;
                if (user.profileImage) completionPoints += 15;
                if (user.industry) completionPoints += 10;
                if (user.location) completionPoints += 10;
                if (user.about && user.about.length > 20) completionPoints += 15;
                if (user.skills && user.skills.length > 0) completionPoints += 15;
                
                // Check for minimum connections
                const hasConnections = user.connections && user.connections.length > 0;
                
                // Return true if profile is at least 50% complete or has connections
                return completionPoints >= 50 || hasConnections;
            }
            
            // Function to initialize analytics with user data
            function initializeAnalytics(user) {
                // Parse and prepare analytics data from user object
                const analyticsData = generateAnalyticsData(user);
                
                // Update UI with analytics data
                updateAnalyticsUI(analyticsData);
                
                // Update distribution charts
                updateNetworkDistribution(analyticsData.networkDistribution);
                
                // Update engagement insights
                updateEngagementInsights(analyticsData);
                
                // Update growth opportunities
                updateGrowthOpportunities(analyticsData);
            }
            
            // Function to generate analytics data from user object
            function generateAnalyticsData(user) {
                // 1. Calculate professional score
                const profileCompletionScore = calculateProfileCompletionScore(user);
                const connectionScore = calculateConnectionScore(user);
                const engagementScore = calculateEngagementScore(user);
                const professionalScore = Math.round((profileCompletionScore * 0.4) + (connectionScore * 0.3) + (engagementScore * 0.3));
                
                // 2. Calculate network metrics
                const networkSize = user.connections ? user.connections.length : 0;
                const networkGrowth = calculateNetworkGrowth(user);
                
                // 3. Calculate profile views
                const profileViews = getRandomMetric(user.id, 'views', 10, 50);
                const profileViewsChange = getRandomMetric(user.id, 'viewsChange', -10, 15);
                
                // 4. Calculate response rate
                const responseRate = getRandomMetric(user.id, 'responseRate', 60, 95);
                const responseRateChange = getRandomMetric(user.id, 'responseRateChange', -5, 10);
                const responseTime = getRandomMetric(user.id, 'responseTime', 1, 12);
                
                // 5. Calculate engagement score
                const weeklyInteractions = getRandomMetric(user.id, 'interactions', 15, 40);
                const interactionsChange = getRandomMetric(user.id, 'interactionsChange', -15, 10);
                
                // 6. Calculate match success rate
                const matchSuccessRate = getRandomMetric(user.id, 'matchSuccess', 50, 85);
                const matchSuccessChange = getRandomMetric(user.id, 'matchSuccessChange', -5, 10);
                
                // 7. Calculate network distribution
                const networkDistribution = calculateNetworkDistribution(user);
                
                // Return analytics data object
                return {
                    professionalScore,
                    scoreChange: getRandomMetric(user.id, 'scoreChange', -3, 8),
                    networkSize,
                    networkGrowth,
                    profileViews,
                    profileViewsChange,
                    responseRate,
                    responseRateChange,
                    responseTime,
                    engagement: weeklyInteractions,
                    engagementChange: interactionsChange,
                    matchSuccessRate,
                    matchSuccessChange,
                    networkDistribution,
                    profileCompletionScore,
                    skillCount: user.skills ? user.skills.length : 0,
                    topSkills: getTopSkills(user)
                };
            }
            
            // Function to calculate profile completion score
            function calculateProfileCompletionScore(user) {
                let score = 0;
                
                // Basic profile
                if (user.fullName) score += 10;
                if (user.profileImage) score += 15;
                if (user.currentRole) score += 10;
                if (user.company) score += 10;
                
                // Extended profile
                if (user.industry) score += 10;
                if (user.location) score += 10;
                if (user.skills && user.skills.length > 0) {
                    score += Math.min(user.skills.length * 5, 15);
                }
                if (user.about) {
                    // Length-based scoring for about section
                    const length = user.about.length;
                    if (length > 20) score += 5;
                    if (length > 50) score += 5;
                    if (length > 100) score += 5;
                }
                
                // Experience
                if (user.experience && user.experience.length > 0) {
                    score += Math.min(user.experience.length * 5, 10);
                }
                
                return score;
            }
            
            // Function to calculate connection score
            function calculateConnectionScore(user) {
                const connections = user.connections || [];
                
                // Base score based on number of connections
                let score = Math.min(connections.length * 5, 80);
                
                // Bonus for recent connections
                const recentConnections = connections.filter(conn => {
                    const now = Date.now();
                    const connTime = conn.timestamp || 0;
                    const daysDiff = (now - connTime) / (1000 * 60 * 60 * 24);
                    return daysDiff < 30;
                }).length;
                
                score += Math.min(recentConnections * 2, 20);
                
                return score;
            }
            
            // Function to calculate engagement score
            function calculateEngagementScore(user) {
                // This would normally be based on actual activity data
                // For demo, generate a random score weighted by profile quality
                
                const baseScore = calculateProfileCompletionScore(user) * 0.8;
                const randomFactor = Math.random() * 20;
                
                return Math.min(baseScore + randomFactor, 100);
            }
            
            // Function to calculate network growth
            function calculateNetworkGrowth(user) {
                const connections = user.connections || [];
                if (connections.length === 0) return 0;
                
                // Calculate number of connections in the last 30 days
                const now = Date.now();
                const recentConnections = connections.filter(conn => {
                    const connTime = conn.timestamp || 0;
                    const daysDiff = (now - connTime) / (1000 * 60 * 60 * 24);
                    return daysDiff < 30;
                }).length;
                
                // Calculate growth percentage
                if (connections.length === recentConnections) {
                    return 100; // All connections are new (100% growth)
                }
                
                return Math.round((recentConnections / (connections.length - recentConnections)) * 100);
            }
            
            // Function to calculate network distribution
            function calculateNetworkDistribution(user) {
                const connections = user.connections || [];
                if (connections.length === 0) {
                    // Default distribution if no connections
                    return [
                        { industry: 'Technology', percentage: 40 },
                        { industry: 'Finance', percentage: 25 },
                        { industry: 'Healthcare', percentage: 15 },
                        { industry: 'Marketing', percentage: 12 },
                        { industry: 'Other', percentage: 8 }
                    ];
                }
                
                // Count industries from actual connections if possible
                // (In a real app, you would have industry data for connections)
                // For demo, generate a distribution based on user's industry
                
                const userIndustry = user.industry || 'Technology';
                
                // Generate a distribution that favors the user's industry
                const distribution = [];
                
                // Add user's industry with highest percentage
                distribution.push({
                    industry: userIndustry,
                    percentage: 35 + Math.floor(Math.random() * 15)
                });
                
                // Add other industries
                const otherIndustries = ['Technology', 'Finance', 'Healthcare', 'Marketing', 'Education', 'Consulting'].filter(i => i !== userIndustry);
                
                // Pick 3 random industries from the others
                const selectedIndustries = [];
                while (selectedIndustries.length < 3 && otherIndustries.length > 0) {
                    const index = Math.floor(Math.random() * otherIndustries.length);
                    selectedIndustries.push(otherIndustries[index]);
                    otherIndustries.splice(index, 1);
                }
                
                // Assign percentages to selected industries
                let remainingPercentage = 100 - distribution[0].percentage;
                
                selectedIndustries.forEach((industry, index) => {
                    if (index === selectedIndustries.length - 1) {
                        // Last industry gets remaining percentage
                        distribution.push({
                            industry: industry,
                            percentage: remainingPercentage
                        });
                    } else {
                        // Assign random percentage
                        const percentage = Math.floor(remainingPercentage * (0.3 + Math.random() * 0.4));
                        distribution.push({
                            industry: industry,
                            percentage: percentage
                        });
                        remainingPercentage -= percentage;
                    }
                });
                
                return distribution;
            }
            
            // Function to get top skills from user
            function getTopSkills(user) {
                if (!user.skills || user.skills.length === 0) {
                    return ['Communication', 'Leadership', 'Problem Solving'];
                }
                
                // If skills is a string, parse it
                let skillsArray = user.skills;
                if (typeof skillsArray === 'string') {
                    skillsArray = skillsArray.split(',').map(s => s.trim());
                }
                
                // Return top 3 skills
                return skillsArray.slice(0, 3);
            }
            
            // Function to get deterministic random metric based on user ID
            function getRandomMetric(userId, metricName, min, max) {
                // Generate a seed using user ID and metric name
                const seed = userId ? (userId + metricName).split('').reduce((a, b) => a + b.charCodeAt(0), 0) : Math.random();
                
                // Use the seed to generate a "random" number between 0 and 1
                const random = Math.sin(seed) * 10000 - Math.floor(Math.sin(seed) * 10000);
                
                // Scale to the desired range
                return Math.floor(min + random * (max - min + 1));
            }
            
            // Function to update analytics UI with data
            function updateAnalyticsUI(data) {
                // Update professional score
                document.getElementById('professionalScore').textContent = data.professionalScore;
                document.getElementById('professionalScoreBar').style.setProperty('--target-width', `${data.professionalScore}%`);
                
                // Update score change
                const scoreChange = document.getElementById('scoreChange');
                if (data.scoreChange > 0) {
                    scoreChange.textContent = `+${data.scoreChange}%`;
                    scoreChange.classList.add('text-success');
                    scoreChange.classList.remove('text-danger');
                } else if (data.scoreChange < 0) {
                    scoreChange.textContent = `${data.scoreChange}%`;
                    scoreChange.classList.add('text-danger');
                    scoreChange.classList.remove('text-success');
                } else {
                    scoreChange.textContent = `${data.scoreChange}%`;
                    scoreChange.classList.remove('text-success', 'text-danger');
                }
                
                // Update network growth
                document.getElementById('networkGrowth').textContent = `${data.networkGrowth}%`;
                const networkGrowthChange = document.getElementById('networkGrowthChange');
                if (data.networkGrowth > 0) {
                    networkGrowthChange.innerHTML = '<i class="fas fa-arrow-up"></i>';
                    networkGrowthChange.classList.add('text-success');
                    networkGrowthChange.classList.remove('text-danger');
                } else if (data.networkGrowth < 0) {
                    networkGrowthChange.innerHTML = '<i class="fas fa-arrow-down"></i>';
                    networkGrowthChange.classList.add('text-danger');
                    networkGrowthChange.classList.remove('text-success');
                } else {
                    networkGrowthChange.innerHTML = '';
                }
                document.getElementById('networkGrowthDesc').textContent = `${data.networkSize} total connections`;
                
                // Update profile views
                document.getElementById('profileViews').textContent = data.profileViews;
                const profileViewsChange = document.getElementById('profileViewsChange');
                if (data.profileViewsChange > 0) {
                    profileViewsChange.innerHTML = '<i class="fas fa-arrow-up"></i>';
                    profileViewsChange.classList.add('text-success');
                    profileViewsChange.classList.remove('text-danger');
                } else if (data.profileViewsChange < 0) {
                    profileViewsChange.innerHTML = '<i class="fas fa-arrow-down"></i>';
                    profileViewsChange.classList.add('text-danger');
                    profileViewsChange.classList.remove('text-success');
                } else {
                    profileViewsChange.innerHTML = '';
                }
                document.getElementById('profileViewsDesc').textContent = `${Math.abs(data.profileViewsChange)}% from last month`;
                
                // Update response rate
                document.getElementById('responseRate').textContent = `${data.responseRate}%`;
                const responseRateChange = document.getElementById('responseRateChange');
                if (data.responseRateChange > 0) {
                    responseRateChange.innerHTML = '<i class="fas fa-arrow-up"></i>';
                    responseRateChange.classList.add('text-success');
                    responseRateChange.classList.remove('text-danger');
                } else if (data.responseRateChange < 0) {
                    responseRateChange.innerHTML = '<i class="fas fa-arrow-down"></i>';
                    responseRateChange.classList.add('text-danger');
                    responseRateChange.classList.remove('text-success');
                } else {
                    responseRateChange.innerHTML = '';
                }
                document.getElementById('responseRateDesc').textContent = `Avg. response time: ${data.responseTime}h`;
                
                // Update engagement
                document.getElementById('engagement').textContent = data.engagement;
                const engagementChange = document.getElementById('engagementChange');
                if (data.engagementChange > 0) {
                    engagementChange.innerHTML = '<i class="fas fa-arrow-up"></i>';
                    engagementChange.classList.add('text-success');
                    engagementChange.classList.remove('text-danger');
                } else if (data.engagementChange < 0) {
                    engagementChange.innerHTML = '<i class="fas fa-arrow-down"></i>';
                    engagementChange.classList.add('text-danger');
                    engagementChange.classList.remove('text-success');
                } else {
                    engagementChange.innerHTML = '';
                }
                document.getElementById('engagementDesc').textContent = `Interactions/week`;
                
                // Update match success
                document.getElementById('matchSuccess').textContent = `${data.matchSuccessRate}%`;
                document.getElementById('matchSuccessBar').style.setProperty('--target-width', `${data.matchSuccessRate}%`);
                const matchSuccessChange = document.getElementById('matchSuccessChange');
                if (data.matchSuccessChange > 0) {
                    matchSuccessChange.innerHTML = '<i class="fas fa-arrow-up"></i>';
                    matchSuccessChange.classList.add('text-success');
                    matchSuccessChange.classList.remove('text-danger');
                } else if (data.matchSuccessChange < 0) {
                    matchSuccessChange.innerHTML = '<i class="fas fa-arrow-down"></i>';
                    matchSuccessChange.classList.add('text-danger');
                    matchSuccessChange.classList.remove('text-success');
                } else {
                    matchSuccessChange.innerHTML = '';
                }
                document.getElementById('matchSuccessDesc').textContent = `Success rate of connection requests`;
            }
            
            // Function to update analytics for different time ranges
            function updateAnalyticsForRange(days) {
                // Show loading state
                analyticsContent.classList.add('hidden');
                loadingState.classList.remove('hidden');
                
                // Simulate data loading
                setTimeout(() => {
                    loadingState.classList.add('hidden');
                    analyticsContent.classList.remove('hidden');
                    
                    // Get current user
                    const user = JSON.parse(localStorage.getItem('currentUser'));
                    if (!user) return;
                    
                    // Generate analytics with time range adjustment
                    const baseData = generateAnalyticsData(user);
                    const rangeData = adjustDataForTimeRange(baseData, days);
                    
                    // Update UI with the range-adjusted data
                    updateAnalyticsUI(rangeData);
                    
                    // Update distribution and insights
                    updateNetworkDistribution(rangeData.networkDistribution);
                    updateEngagementInsights(rangeData);
                    updateGrowthOpportunities(rangeData);
                }, 500);
            }
            
            // Function to adjust analytics data for different time ranges
            function adjustDataForTimeRange(baseData, days) {
                // Make shallow copy of base data
                const rangeData = {...baseData};
                
                // Adjust metrics based on time range
                if (days === 90) { // 3 months
                    rangeData.professionalScore = Math.max(1, baseData.professionalScore - Math.floor(Math.random() * 8));
                    rangeData.networkGrowth = Math.floor(baseData.networkGrowth * (2 + Math.random()));
                    rangeData.profileViews = Math.floor(baseData.profileViews * (2.5 + Math.random()));
                    rangeData.responseRate = clipValue(baseData.responseRate - Math.floor(Math.random() * 10), 0, 100);
                    rangeData.engagement = Math.floor(baseData.engagement * (0.8 + Math.random() * 0.4));
                    rangeData.matchSuccessRate = clipValue(baseData.matchSuccessRate - Math.floor(Math.random() * 5), 0, 100);
                } else if (days === 180) { // 6 months
                    rangeData.professionalScore = Math.max(1, baseData.professionalScore - Math.floor(Math.random() * 12));
                    rangeData.networkGrowth = Math.floor(baseData.networkGrowth * (3 + Math.random() * 2));
                    rangeData.profileViews = Math.floor(baseData.profileViews * (4 + Math.random() * 2));
                    rangeData.responseRate = clipValue(baseData.responseRate - Math.floor(Math.random() * 15), 0, 100);
                    rangeData.engagement = Math.floor(baseData.engagement * (0.7 + Math.random() * 0.3));
                    rangeData.matchSuccessRate = clipValue(baseData.matchSuccessRate - Math.floor(Math.random() * 10), 0, 100);
                } else if (days === 365) { // 1 year
                    rangeData.professionalScore = Math.max(1, baseData.professionalScore - Math.floor(Math.random() * 25));
                    rangeData.networkGrowth = Math.floor(baseData.networkGrowth * (5 + Math.random() * 3));
                    rangeData.profileViews = Math.floor(baseData.profileViews * (7 + Math.random() * 3));
                    rangeData.responseRate = clipValue(baseData.responseRate - Math.floor(Math.random() * 20), 0, 100);
                    rangeData.engagement = Math.floor(baseData.engagement * (0.6 + Math.random() * 0.3));
                    rangeData.matchSuccessRate = clipValue(baseData.matchSuccessRate - Math.floor(Math.random() * 15), 0, 100);
                }
                
                // Adjust changes to be more negative for longer time ranges
                rangeData.scoreChange = baseData.scoreChange + (days > 30 ? Math.floor(Math.random() * 10) : 0);
                rangeData.profileViewsChange = baseData.profileViewsChange + (days > 30 ? Math.floor(Math.random() * 15) : 0);
                rangeData.responseRateChange = baseData.responseRateChange + (days > 30 ? Math.floor(Math.random() * 10) : 0);
                rangeData.engagementChange = baseData.engagementChange + (days > 30 ? Math.floor(Math.random() * 15) : 0);
                rangeData.matchSuccessChange = baseData.matchSuccessChange + (days > 30 ? Math.floor(Math.random() * 10) : 0);
                
                return rangeData;
            }
            
            // Helper function to clip values to a range
            function clipValue(value, min, max) {
                return Math.min(Math.max(value, min), max);
            }
            
            // Function to update network distribution
            function updateNetworkDistribution(distribution) {
                networkDistribution.innerHTML = '';
                
                distribution.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'mb-3';
                    
                    div.innerHTML = `
                        <div class="flex justify-between mb-1">
                            <span class="text-xs">${item.industry}</span>
                            <span class="text-xs">${item.percentage}%</span>
                        </div>
                        <div class="w-full bg-lightTertiary rounded-full h-1.5">
                            <div class="bg-primary h-1.5 rounded-full animate-grow" style="--target-width: ${item.percentage}%"></div>
                        </div>
                    `;
                    
                    networkDistribution.appendChild(div);
                });
            }
            
            // Function to update engagement insights
            function updateEngagementInsights(data) {
                engagementInsights.innerHTML = '';
                
                // Generate insights based on data
                const insights = [
                    {
                        icon: 'star',
                        color: 'primary',
                        text: `Your profile is viewed ${data.profileViewsChange > 0 ? data.profileViewsChange + '% more' : 'frequently'} compared to similar professionals`
                    },
                    {
                        icon: data.responseRate > 80 ? 'award' : 'bell',
                        color: data.responseRate > 80 ? 'success' : 'accent',
                        text: data.responseRate > 80 ? 
                            `Your response rate is among the top 25% of users` : 
                            `Improve your response rate to stand out from other professionals`
                    },
                    {
                        icon: 'users',
                        color: 'primary',
                        text: `Your network is primarily in the ${data.networkDistribution[0].industry} industry (${data.networkDistribution[0].percentage}%)`
                    }
                ];
                
                // Add insights to DOM
                insights.forEach(insight => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center';
                    div.innerHTML = `
                        <div class="w-8 h-8 bg-${insight.color}/10 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                            <i class="fas fa-${insight.icon} text-${insight.color}"></i>
                        </div>
                        <div>
                            <p class="text-sm">${insight.text}</p>
                        </div>
                    `;
                    
                    engagementInsights.appendChild(div);
                });
            }
            
            // Function to update growth opportunities
            function updateGrowthOpportunities(data) {
                growthOpportunities.innerHTML = '';
                
                // Generate opportunities based on data
                const opportunities = [];
                
                // Add skill-related opportunity
                if (data.skillCount < 5) {
                    opportunities.push({
                        icon: 'tools',
                        title: 'Add more skills',
                        description: `Adding ${5 - data.skillCount} more skills could improve your match rate by 15%`,
                        action: 'Edit Skills',
                        link: 'profile.html'
                    });
                }
                
                // Add connection-related opportunity
                if (data.networkSize < 20) {
                    opportunities.push({
                        icon: 'user-plus',
                        title: 'Grow your network',
                        description: `Connect with ${20 - data.networkSize} more professionals to boost your visibility`,
                        action: 'Find Connections',
                        link: 'search.html'
                    });
                }
                
                // Add response rate opportunity
                if (data.responseRate < 85) {
                    opportunities.push({
                        icon: 'reply',
                        title: 'Improve response time',
                        description: 'Responding faster can increase your engagement by up to 30%',
                        action: 'Check Messages',
                        link: 'chat.html'
                    });
                }
                
                // Add profile completion opportunity if below 90%
                if (data.profileCompletionScore < 90) {
                    opportunities.push({
                        icon: 'id-card',
                        title: 'Complete your profile',
                        description: 'A complete profile receives up to 40% more views',
                        action: 'Update Profile',
                        link: 'profile.html'
                    });
                }
                
                // Add industry diversification if top industry is over 50%
                if (data.networkDistribution[0].percentage > 50) {
                    opportunities.push({
                        icon: 'random',
                        title: 'Diversify your network',
                        description: 'Connecting with professionals from other industries widens your opportunities',
                        action: 'Find Connections',
                        link: 'search.html'
                    });
                }
                
                // Only show 3 opportunities max
                opportunities.slice(0, 3).forEach(opportunity => {
                    const div = document.createElement('div');
                    div.className = 'bg-lightSecondary p-4 rounded-lg';
                    div.innerHTML = `
                        <div class="flex items-start">
                            <div class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                <i class="fas fa-${opportunity.icon} text-primary"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-medium mb-1">${opportunity.title}</h3>
                                <p class="text-sm text-textMedium mb-3">${opportunity.description}</p>
                                <a href="${opportunity.link}" class="text-primary text-sm font-medium">
                                    ${opportunity.action} <i class="fas fa-arrow-right ml-1"></i>
                                </a>
                            </div>
                        </div>
                    `;
                    
                    growthOpportunities.appendChild(div);
                });
            }
        });
    </script>
</body>
</html>
